<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Venus Workshop</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Telegram WebApp –¥–ª—è —Ä–∞–±–æ—Ç—ã –≤ –±–æ—Ç–µ -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- –®—Ä–∏—Ñ—Ç—ã –∏ –≥—Ä–∞—Ñ–∏–∫–∏ -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      /* === –¶–í–ï–¢–û–í–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ò –¢–ï–ú–´ === */
      :root { 
        --bg-app: #F2F2F7;
        --bg-panel: linear-gradient(180deg, #FFFFFF 0%, #F5F7FA 100%);      
        --text-main: #1C1C1E;     
        --text-sub: #8E8E93;      
        --accent: #007AFF;        
        --border: rgba(0,0,0,0.08); 
        --border-strong: #C7C7CC;
        --input-bg: #FFFFFF;      
        
        --color-inc: #34C759; /* –î–æ—Ö–æ–¥ - –ó–µ–ª–µ–Ω—ã–π */
        --color-exp: #FF3B30; /* –†–∞—Å—Ö–æ–¥ - –ö—Ä–∞—Å–Ω—ã–π */
        --color-prof: #5856D6; /* –ü—Ä–∏–±—ã–ª—å - –§–∏–æ–ª–µ—Ç–æ–≤—ã–π */
        --color-vis: #AF52DE; /* –ü–æ—Å–µ—Ç–∏—Ç–µ–ª–∏ - –ü—É—Ä–ø—É—Ä–Ω—ã–π */
        
        --danger: #FF3B30;
        --shadow-card: 0 4px 12px rgba(0,0,0,0.06);
        --radius: 20px;
        --scroll-thumb: #C7C7CC;
      }
      
      [data-theme="dark"] { 
        --bg-app: #0f172a;
        --bg-panel: #1e293b; 
        --text-main: #f8fafc;     
        --text-sub: #94a3b8;      
        --accent: #60a5fa;        
        --border: #334155;        
        --border-strong: #475569;
        --input-bg: #0f172a;      
        
        --shadow-card: 0 4px 20px rgba(0,0,0,0.4);
        --color-inc: #4ade80;     
        --color-exp: #f87171;     
        --color-prof: #818cf8;    
        --color-vis: #c084fc;     
        --scroll-thumb: #475569;
      }
      
      * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
      
      body { 
          margin: 0; padding: 20px; 
          font-family: 'Inter', sans-serif; 
          background-color: var(--bg-app); color: var(--text-main); 
          height: 100vh; height: 100dvh; 
          overflow: hidden; 
          display:flex; flex-direction:column;
          -webkit-font-smoothing: antialiased; font-weight: 500;
      }

      /* === –û–ö–ù–û –°–ü–ò–°–ö–ê –ë–†–û–ù–ò–†–û–í–ê–ù–ò–ô (–ö–ê–†–¢–û–ß–ö–ê –ü–û –¶–ï–ù–¢–†–£) === */
      #bookingSheet {
          align-items: center !important;
          justify-content: center !important;
          padding: 20px;
      }
      #bookingSheetBox {
          width: 100%; max-width: 400px; max-height: 80vh;
          border-radius: 24px; margin: 0 auto;
          transform: scale(0.95); opacity: 0;
          animation: popInCenter 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
          background: var(--bg-panel);
          display: flex; flex-direction: column;
          box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      }
      @keyframes popInCenter { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
      
      /* === iOS PICKER (–ï–î–ò–ù–´–ô –°–¢–ò–õ–¨ –î–õ–Ø –í–°–ï–• –°–ü–ò–°–ö–û–í) === */
      .ios-picker-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.6); z-index: 5000;
        display: none; align-items: flex-end; justify-content: center;
        backdrop-filter: blur(3px);
      }
      .ios-picker-container {
        background: #1c1c1e; /* –¢–µ–º–Ω—ã–π —Ñ–æ–Ω –≤—Å–µ–≥–¥–∞ –¥–ª—è —Å—Ç–∏–ª—è iOS */
        width: 100%; max-width: 500px;
        border-top-left-radius: 16px; border-top-right-radius: 16px;
        overflow: hidden; padding-bottom: 20px;
        box-shadow: 0 -5px 20px rgba(0,0,0,0.3);
        animation: slideUpPicker 0.3s ease-out;
        --item-height: 44px; --picker-height: 220px;
        --text-main: #ffffff; --text-muted: #8e8e93;
        color: white;
      }
      @keyframes slideUpPicker { from { transform: translateY(100%); } to { transform: translateY(0); } }

      .ios-tabs {
        display: flex; background: #1c1c1e; padding: 10px 15px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        justify-content: space-between; align-items: center;
      }
      .ios-tab-btn { background: none; border: none; font-size: 17px; cursor: pointer; color: #0a84ff; font-weight: 600; padding: 5px 10px; }
      .ios-tab-title { font-weight: 600; font-size: 17px; color: white; }

      .picker-area {
        position: relative; height: var(--picker-height);
        display: flex; justify-content: center;
        mask-image: linear-gradient(to bottom, transparent, black 20%, black 80%, transparent);
        -webkit-mask-image: linear-gradient(to bottom, transparent, black 20%, black 80%, transparent);
      }
      .picker-highlight {
        position: absolute; top: 50%; left: 0; right: 0; height: 36px;
        transform: translateY(-50%); pointer-events: none; z-index: 0;
        background: rgba(255,255,255,0.08);
        border-top: 1px solid rgba(255, 255, 255, 0.15); border-bottom: 1px solid rgba(255, 255, 255, 0.15);
      }
      .picker-col {
        flex: 1; height: 100%; overflow-y: scroll;
        scroll-snap-type: y mandatory; scrollbar-width: none;
        z-index: 1; padding: 0; margin: 0; text-align: center;
      }
      .picker-col::-webkit-scrollbar { display: none; }
      .picker-item {
        height: var(--item-height); display: flex; align-items: center; justify-content: center;
        font-size: 21px; color: var(--text-muted); scroll-snap-align: center;
        transition: 0.2s; opacity: 0.4; transform: scale(0.9);
      }
      .picker-item.active { opacity: 1; color: var(--text-main); transform: scale(1.1); font-weight: 500; }
      
      /* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —à–∏—Ä–∏–Ω—ã –∫–æ–ª–æ–Ω–æ–∫ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ */
      .layout-date .picker-col:nth-child(1) { flex: 0.8; } 
      .layout-date .picker-col:nth-child(2) { flex: 2; }
      .layout-date .picker-col:nth-child(3) { flex: 1.2; }
      .layout-time .picker-col { flex: 1; }
      .padder { height: calc((var(--picker-height) - var(--item-height)) / 2); width: 100%; }

      /* === –û–ë–©–ò–ô –õ–≠–ô–ê–£–¢ === */
      .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-shrink: 0; }
      .brand-box { display: flex; align-items: center; gap: 12px; }
      .title { margin: 0; font-size: 24px; font-weight: 800; color: var(--text-main); letter-spacing: -0.5px; }
      .venus-icon { width: 42px; height: 42px; cursor: pointer; transition: transform 0.5s ease; position: relative; z-index: 5; }
      .venus-icon.spinning { animation: spinInfinite 1.5s linear infinite; }
      @keyframes spinInfinite { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

      .nav { display: flex; background: var(--bg-panel); padding: 4px; border-radius: 14px; margin-bottom: 20px; flex-shrink: 0; box-shadow: var(--shadow-card); border: 1px solid var(--border); position: relative; }
      .nav-btn { flex: 1; padding: 10px; border: none; background: transparent; color: var(--text-sub); border-radius: 10px; cursor: pointer; font-weight: 600; text-align: center; transition: 0.2s; font-size: 14px; z-index: 2; position: relative; display: flex; align-items: center; justify-content: center; gap:8px;}
      .nav-btn.active { color: var(--text-main); background: var(--bg-app); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
      [data-theme="dark"] .nav-btn.active { background: #334155; box-shadow: none; }
      .nav-btn svg { width: 18px; height: 18px; fill: currentColor; opacity: 0.7; }
      .nav-btn.active svg { opacity: 1; color: var(--accent); fill: var(--accent); }
      .nav-indicator { display: none; }

      .content-area { flex: 1; position: relative; overflow: hidden; border-radius: var(--radius); display: flex; }
      .tab-page { display: none; width: 100%; height: 100%; }
      .tab-page.active { display: block; }
      
      .anim-fade { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

      .split-view { display: flex; height: 100%; gap: 20px; }
      .panel { background: var(--bg-panel); border-radius: var(--radius); box-shadow: var(--shadow-card); overflow: hidden; display: flex; flex-direction: column; border: 1px solid var(--border); }
      .panel-left { width: 360px; padding: 30px; flex-shrink: 0; overflow-y: auto; }
      .panel-right { flex: 1; }
      
      h3 { margin-top: 0; font-size: 18px; font-weight: 700; color: var(--text-main); margin-bottom: 20px; }
      label { font-size: 12px; font-weight: 700; color: var(--text-sub); margin-bottom: 8px; display: block; letter-spacing: 0.02em; }
      
      input, select, .custom-select-trigger { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid var(--border-strong); background-color: var(--input-bg); color: var(--text-main); font-size: 15px; box-sizing: border-box; outline:none; transition:0.2s; font-weight: 600; font-family: 'Inter', sans-serif; cursor: pointer; }
      input:focus { border-color: var(--accent); }
      
      .qty-wrapper { display: flex; align-items: center; background: var(--input-bg); border: 1px solid var(--border-strong); border-radius: 12px; overflow: hidden; padding: 2px; }
      .qty-btn { width: 44px; height: 44px; background: transparent; border: none; color: var(--text-main); font-size: 20px; cursor: pointer; border-radius: 10px; transition: 0.2s; font-weight: 600; }
      .qty-input { text-align: center; border: none; font-weight: 700; font-size: 18px; flex: 1; padding: 0; background: transparent; color: var(--text-main); -moz-appearance: textfield; }
      .btn { width: 100%; padding: 18px; background: var(--accent); color: white; border: none; border-radius: 16px; font-weight: 700; cursor: pointer; margin-top: 20px; font-size: 16px; transition: 0.2s; }
      .btn:active { transform: scale(0.98); opacity: 0.9; }
      
      .table-header { padding: 20px 30px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
      .grid-wrapper { flex: 1; overflow-y: auto; padding: 0 10px; }
      table { width: 100%; border-collapse: separate; border-spacing: 0 8px; min-width: 500px; }
      th { position: sticky; top: 0; background: var(--bg-panel); color: var(--text-sub); font-size: 11px; text-transform: uppercase; text-align: left; padding: 10px 15px; font-weight: 700; z-index: 10; }
      td { padding: 16px 10px; background: var(--input-bg); border: 1px solid var(--border); font-size: 14px; color: var(--text-main); vertical-align: middle; font-weight: 500; }
      tr td:first-child { border-top-left-radius: 14px; border-bottom-left-radius: 14px; border-right: none; }
      tr td:last-child { border-top-right-radius: 14px; border-bottom-right-radius: 14px; text-align: right; border-left: none; }
      .btn-table { padding: 0; width: 34px; height: 34px; border-radius: 10px; cursor: pointer; border: 1px solid var(--border-strong); background: transparent; color: var(--text-sub); margin-left: 4px; display: inline-flex; align-items: center; justify-content: center; }
      .btn-table svg { width: 16px; height: 16px; fill: currentColor; }

      /* –ö–∞–ª–µ–Ω–¥–∞—Ä—å */
      .calendar-page { display: flex; flex-direction: column; gap: 16px; width: 100%; height: 100%; }
      .calendar-panel { background: var(--bg-panel); border-radius: var(--radius); box-shadow: var(--shadow-card); border: 1px solid var(--border); padding: 18px; display: flex; flex-direction: column; gap: 16px; height: 100%; box-sizing: border-box; }
      .calendar-header { display: flex; justify-content: space-between; align-items: center; gap: 12px; flex-wrap: wrap; }
      .calendar-title { font-size: 20px; font-weight: 800; color: var(--text-main); letter-spacing: -0.3px; }
      .calendar-controls { display: flex; align-items: center; gap: 8px; }
      .calendar-btn { width: 38px; height: 38px; border-radius: 12px; border: 1px solid var(--border-strong); background: var(--input-bg); color: var(--text-main); cursor: pointer; display: inline-flex; align-items: center; justify-content: center; font-weight: 800; transition: 0.2s; }
      .year-pill { display: inline-flex; align-items: center; gap: 8px; background: var(--input-bg); border: 1px solid var(--border-strong); border-radius: 12px; padding: 10px 12px; font-weight: 700; color: var(--text-main); }
      .calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; font-size: 12px; font-weight: 700; color: var(--text-sub); text-transform: uppercase; letter-spacing: 0.5px; }
      .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; flex: 1; position: relative; }
      .calendar-cell { min-height: 80px; border-radius: 14px; background: var(--input-bg); border: 1px solid var(--border); padding: 10px; display: flex; align-items: flex-start; justify-content: flex-start; font-weight: 800; color: var(--text-main); position: relative; box-shadow: var(--shadow-card); transition: transform 0.2s; }
      .calendar-cell:hover { transform: translateY(-2px); }
      .calendar-cell.outside { opacity: 0.45; pointer-events: none; background: linear-gradient(180deg, rgba(0,0,0,0.02), rgba(0,0,0,0.01)); }
      .calendar-cell[data-level="1"] { background: color-mix(in srgb, var(--accent) 12%, transparent); border-color: color-mix(in srgb, var(--accent) 28%, var(--border)); }
      .calendar-cell[data-level="2"] { background: color-mix(in srgb, var(--accent) 18%, transparent); border-color: color-mix(in srgb, var(--accent) 38%, var(--border-strong)); }
      .calendar-cell[data-level="3"] { background: color-mix(in srgb, var(--color-exp) 18%, transparent); border-color: color-mix(in srgb, var(--color-exp) 36%, var(--border-strong)); }
      .calendar-cell.clickable { cursor: pointer; }

      /* –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ */
      .analytics-container { padding: 0 10px 20px 10px; overflow-y: auto; height: 100%; width: 100%; box-sizing: border-box; }
      .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
      .kpi-card { background: var(--bg-panel); padding: 25px; border-radius: 24px; box-shadow: var(--shadow-card); border: 1px solid var(--border); }
      .kpi-title { font-size: 12px; color: var(--text-sub); text-transform: uppercase; font-weight: 700; margin-bottom: 8px; }
      .kpi-val { font-size: 32px; font-weight: 800; color: var(--text-main); }
      .kpi-trend { font-size: 13px; font-weight: 700; margin-top: 5px; display: inline-block; padding: 4px 10px; border-radius: 20px; }
      .trend-up { background: rgba(52, 199, 89, 0.15); color: var(--color-inc); }
      .trend-down { background: rgba(255, 59, 48, 0.15); color: var(--color-exp); }
      .charts-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; margin-bottom: 25px; }
      .chart-box { background: var(--bg-panel); border-radius: 24px; padding: 25px; box-shadow: var(--shadow-card); display: flex; flex-direction: column; min-height: 320px; border: 1px solid var(--border); }
      .chart-head { font-weight: 700; font-size: 18px; margin-bottom: 20px; color: var(--text-main); }
      .chart-canv { flex: 1; position: relative; }
      .prog-list { display: flex; flex-direction: column; gap: 10px; }
      .prog-item { display: flex; flex-direction: column; gap: 4px; }
      .prog-info { display: flex; justify-content: space-between; font-size: 13px; font-weight: 600; color: var(--text-main); }
      .prog-bar-bg { width: 100%; height: 6px; background: var(--input-bg); border-radius: 3px; overflow: hidden; border: 1px solid var(--border); }
      .prog-bar-fill { height: 100%; border-radius: 3px; }
      
      /* –ö–∞—Ä—Ç–æ—á–∫–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è */
      .booking-card { background: var(--input-bg); border: 1px solid var(--border); border-radius: 16px; padding: 14px; box-shadow: var(--shadow-card); display: flex; flex-direction: column; gap: 10px; animation: fadeIn 0.25s ease; }
      .booking-status { padding: 6px 10px; border-radius: 10px; font-size: 12px; font-weight: 700; text-transform: uppercase; }
      .status-planned { background: color-mix(in srgb, var(--accent) 18%, transparent); color: var(--accent); }
      .status-done { background: color-mix(in srgb, var(--color-inc) 18%, transparent); color: var(--color-inc); }
      .status-canceled { background: color-mix(in srgb, var(--danger) 18%, transparent); color: var(--danger); }
      .booking-btn { flex: 1; padding: 10px 12px; border-radius: 12px; border: 1px solid var(--border-strong); background: var(--bg-panel); color: var(--text-main); font-weight: 700; cursor: pointer; }

      /* –ú–æ–¥–∞–ª–∫–∏ */
      .modal-overlay, .sheet-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
      .modal-box { background: var(--bg-panel); padding: 25px; border-radius: 20px; width: 340px; border: 1px solid var(--border); box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: popIn 0.3s forwards; }
      .sheet-box { width: 100%; background: var(--bg-panel); border-top-left-radius: 24px; border-top-right-radius: 24px; padding: 20px; box-shadow: 0 -10px 40px rgba(0,0,0,0.2); animation: slideUp 0.3s forwards; max-height: 85vh; overflow-y: auto; }
      .sheet-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
      .sheet-title { font-weight: 700; font-size: 16px; color: var(--text-main); }
      .sheet-close { color: var(--accent); font-weight: 600; cursor: pointer; padding: 5px; }
      .booking-form-grid { display: flex; flex-direction: column; gap: 12px; }
      .booking-form-row { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px; }
      .field-error { color: var(--danger); font-size: 12px; font-weight: 700; margin-top: 4px; min-height: 14px; }
      .booking-total { font-size: 18px; font-weight: 800; margin-top: 4px; color: var(--text-main); display: flex; justify-content: space-between; align-items: center; background: var(--input-bg); padding: 12px 14px; border-radius: 12px; border: 1px solid var(--border-strong); }
      .booking-sheet-content { display: flex; flex-direction: column; gap: 12px; overflow-y: auto; flex:1; padding-bottom:10px; }
      @keyframes popIn { to { transform: scale(1); } }
      @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

      .loader { position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.01); z-index:50; display:none; }
      .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #1e293b; color: white; padding: 12px 24px; border-radius: 8px; opacity: 0; transition: 0.3s; z-index: 3000; font-size: 14px; font-weight: 500; pointer-events: none; }
      .toast.show { opacity: 1; bottom: 100px; }
      .search-res { position: absolute; top: 100%; left: 0; width: 100%; background: var(--bg-panel); border: 1px solid var(--border); border-radius: 14px; z-index: 100; max-height: 200px; overflow-y: auto; display: none; margin-top: 8px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); }
      .res-item { padding: 14px 20px; cursor: pointer; border-bottom: 1px solid var(--border); font-size: 15px; color: var(--text-main); font-weight: 600; }

      @media (max-width: 768px) {
        body { padding: 0; overflow: hidden; }
        .header { padding: 5px 15px 0 15px; margin-bottom: 5px; height: 40px; }
        .venus-icon { width: 32px; height: 32px; }
        .title { font-size: 18px; }
        .content-area { overflow-y: auto; display: block; padding: 0 5px 120px 5px; height: 100%; }
        .tab-page { height: auto; }
        .split-view { flex-direction: column; gap: 15px; height: auto; }
        .panel { border-radius: 20px; }
        .panel-left, .panel-right { width: 100%; height: auto; padding: 20px; box-sizing: border-box; }
        input, select, .custom-select-trigger { padding: 10px; font-size: 13px; height: 40px; }
        .nav { position: fixed; bottom: 20px; left: 20px; right: 20px; margin: 0; border-radius: 20px; background: var(--bg-panel); box-shadow: 0 10px 40px rgba(0,0,0,0.15); z-index: 1000; display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; padding: 5px; height: 60px; border: 1px solid var(--border); }
        .nav-indicator { display: block; position: absolute; top: 5px; left: 5px; height: calc(100% - 10px); width: calc((100% - 10px) / 4); background: var(--bg-app); border-radius: 16px; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 2px 10px rgba(0,0,0,0.05); z-index: 1; }
        .nav-btn { background: transparent !important; box-shadow: none !important; flex-direction: column; gap: 4px; font-size: 10px; color: var(--text-sub); width: 100%; }
        .nav-btn svg { width: 22px; height: 22px; margin-bottom: 2px; }
        .nav-btn.active { color: var(--accent); }
        .nav-btn.active svg { transform: translateY(-2px); fill: var(--accent); }
        .calendar-cell { min-height: 70px; }
      }
    </style>
</head>
<body data-theme="light">

    <div id="toast" class="toast">–°–æ–æ–±—â–µ–Ω–∏–µ</div>
    <div id="loader" class="loader"></div>

    <div class="header">
        <div class="brand-box">
            <svg id="venus" onclick="toggleTheme(event)" class="venus-icon" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="50" cy="50" r="48" fill="url(#venusGrad)" />
                <path d="M10 50C10 50 30 40 50 40C70 40 90 50 90 50" stroke="rgba(255,255,255,0.3)" stroke-width="4"/>
                <path d="M15 30C15 30 35 25 50 25C65 25 85 30 85 30" stroke="rgba(255,255,255,0.2)" stroke-width="3"/>
                <path d="M15 70C15 70 35 75 50 75C65 75 85 70 85 70" stroke="rgba(255,255,255,0.2)" stroke-width="3"/>
                <defs><radialGradient id="venusGrad" cx="0" cy="0" r="1" gradientUnits="userSpaceOnUse" gradientTransform="translate(30 30) rotate(0) scale(70)"><stop stop-color="#FFD700"/><stop offset="1" stop-color="#FF8C00"/></radialGradient></defs>
            </svg>
            <div class="title">–ú–∞—Å—Ç–µ—Ä—Å–∫–∞—è –í–µ–Ω–µ—Ä–∞</div>
        </div>
    </div>

    <div class="nav">
        <div class="nav-indicator" id="navInd"></div>
        <button class="nav-btn active" onclick="switchTab('income', 0)"><svg viewBox="0 0 24 24"><path d="M21 18V19C21 20.1 20.1 21 19 21H5C3.89 21 3 20.1 3 19V5C3 3.9 3.89 3 5 3H19C20.1 3 21 3.9 21 5V6H12C10.89 6 10 6.9 10 8V16C10 17.1 10.89 18 12 18H21ZM12 16H22V8H12V16ZM16 13.5C15.17 13.5 14.5 12.83 14.5 12C14.5 11.17 15.17 10.5 16 10.5C16.83 10.5 17.5 11.17 17.5 12C17.5 12.83 16.83 13.5 16 13.5Z"/></svg>–ú–ö</button>
        <button class="nav-btn" onclick="switchTab('expense', 1)"><svg viewBox="0 0 24 24"><path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/></svg>–†–∞—Å—Ö–æ–¥</button>
        <button class="nav-btn" onclick="switchTab('calendar', 2)"><svg viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.1 0-1.99.9-1.99 2L3 20c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11z"/></svg>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</button>
        <button class="nav-btn" onclick="switchTab('analytics', 3)"><svg viewBox="0 0 24 24"><path d="M19 3H5C3.9 3 3 3.9 3 5V19C3 20.1 3.9 21 5 21H19C20.1 21 21 20.1 21 19V5C21 3.9 20.1 3 19 3ZM9 17H7V10H9V17ZM13 17H11V7H13V17ZM17 17H15V13H17V17Z"/></svg>–ò–Ω—Ñ–æ</button>
    </div>

    <div class="content-area">
        <div id="splitTab" class="tab-page active">
            <div class="split-view">
                <div class="panel panel-left">
                     <h3 id="formTitle">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</h3>
                    <div style="margin-bottom:15px; position:relative;"><label id="lblSearch">–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" id="inpName" placeholder="–ü–æ–∏—Å–∫ –∏–ª–∏ –Ω–æ–≤–æ–µ..." autocomplete="off" oninput="showSearch(event); calcTotal()"><div class="search-res" id="searchRes"></div></div>
                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <div style="flex:1"><label>–¶–µ–Ω–∞</label><div class="qty-wrapper"><button class="qty-btn" onclick="modVal('inpPrice', -100)">‚àí</button><input type="number" id="inpPrice" class="qty-input" placeholder="0" oninput="calcTotal()"><button class="qty-btn" onclick="modVal('inpPrice', 100)">+</button></div></div>
                        <div style="flex:1"><label>–ö–æ–ª-–≤–æ</label><div class="qty-wrapper"><button class="qty-btn" onclick="modVal('inpQty', -1)">‚àí</button><input type="number" id="inpQty" class="qty-input" value="1" oninput="calcTotal()"><button class="qty-btn" onclick="modVal('inpQty', 1)">+</button></div></div>
                    </div>
                    <div style="text-align:center; margin-top:auto; padding: 10px; background: var(--input-bg); border-radius: 16px; border: 1px solid var(--border);">
                        <span style="font-size:9px; color:var(--text-sub); text-transform:uppercase; font-weight:700; display:block; margin-bottom:2px;">–ò—Ç–æ–≥–æ –∫ –∑–∞–ø–∏—Å–∏</span>
                        <div id="txtTotal" style="font-size:24px; font-weight:800; color:var(--text-main)">0 ‚ÇΩ</div>
                    </div>
                    <button id="btnAdd" class="btn" onclick="submitEntry()">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
                </div>
                <div class="panel panel-right">
                    <div class="table-header"><h3 id="tableTitle" style="margin:0">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏</h3><button class="btn" style="width:auto; padding:8px 16px; font-size:12px; margin:0;" onclick="refreshTable(true)">–û–±–Ω–æ–≤–∏—Ç—å</button></div>
                    <div class="grid-wrapper"><table id="mainTable"><thead><tr><th>–î–∞—Ç–∞</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–°—É–º–º–∞</th><th></th></tr></thead><tbody id="tableBody"></tbody></table><div id="emptyMsg" style="padding:40px; text-align:center; color:var(--text-sub);">–ù–∞–∂–º–∏—Ç–µ "–û–±–Ω–æ–≤–∏—Ç—å"</div></div>
                </div>
            </div>
        </div>

        <div id="calendarTab" class="tab-page">
            <div class="calendar-page">
                <div class="calendar-panel">
                    <div class="calendar-header">
                        <div style="display:flex;align-items:center;gap:8px;"><div class="calendar-title" id="calendarTitle">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</div></div>
                        <div class="calendar-actions">
                             <div class="calendar-controls"><button class="calendar-btn" onclick="changeYear(-1)">‚àí</button><div class="year-pill" id="calendarYearLabel">2024</div><button class="calendar-btn" onclick="changeYear(1)">+</button></div>
                             <div class="calendar-controls"><button class="calendar-btn" onclick="changeMonth(-1)">‚Üê</button><button class="calendar-btn" onclick="changeMonth(1)">‚Üí</button></div>
                        </div>
                    </div>
                    <div class="calendar-weekdays" id="calendarWeekdays"></div>
                    <div class="calendar-grid" id="calendarGrid"></div>
                </div>
            </div>
        </div>

        <div id="analyticsTab" class="tab-page">
            <div class="analytics-container">
                 <div class="filters-row" style="display:flex;gap:15px;margin-bottom:25px;">
                    <!-- –û–ë–ù–û–í–õ–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º openIOSPicker –≤–º–µ—Å—Ç–æ openSheet -->
                    <div class="custom-select-wrapper" onclick="openIOSPicker('year_filter', selYear, (v)=>{selYear=v; updateFilterUI(); loadAnalytics();})"><div class="custom-select-trigger"><span id="txtYear">–ì–æ–¥</span></div></div>
                    <div class="custom-select-wrapper" onclick="openIOSPicker('month_filter', selMonth, (v)=>{selMonth=v; updateFilterUI(); loadAnalytics();})"><div class="custom-select-trigger"><span id="txtMonth">–ú–µ—Å—è—Ü</span></div></div>
                </div>
                <div class="kpi-grid">
                    <div class="kpi-card"><div class="kpi-title">–í–´–†–£–ß–ö–ê</div><div class="kpi-val" style="color:var(--color-inc)" id="kpiInc">0</div><div id="trendInc"></div></div>
                    <div class="kpi-card"><div class="kpi-title">–†–ê–°–•–û–î–´</div><div class="kpi-val" style="color:var(--color-exp)" id="kpiExp">0</div><div id="trendExp"></div></div>
                    <div class="kpi-card"><div class="kpi-title">–ü–†–ò–ë–´–õ–¨</div><div class="kpi-val" style="color:var(--color-prof)" id="kpiProf">0</div><div id="trendProf"></div></div>
                    <div class="kpi-card"><div class="kpi-title">–ü–û–°–ï–¢–ò–¢–ï–õ–ò</div><div class="kpi-val" style="color:var(--color-vis)" id="kpiVis">0</div><div id="trendVis"></div></div>
                </div>
                <div class="charts-grid"><div class="chart-box"><div class="chart-head">–ü—É–ª—å—Å</div><div class="chart-canv"><canvas id="chartPulse"></canvas></div></div><div class="chart-box" style="min-height:300px"><div class="chart-head">–¢–æ–ø –î–æ—Ö–æ–¥–æ–≤</div><div id="listInc" class="prog-list"></div></div></div>
                <div class="charts-grid"><div class="chart-box"><div class="chart-head">–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å</div><div class="chart-canv"><canvas id="chartAttendance"></canvas></div></div><div class="chart-box" style="min-height:300px"><div class="chart-head">–¢–æ–ø –†–∞—Å—Ö–æ–¥–æ–≤</div><div id="listExp" class="prog-list"></div></div></div>
            </div>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê -->
    <div id="editModal" class="modal-overlay"><div class="modal-box"><h3 style="margin-bottom:20px;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h3><input type="hidden" id="editId"><input type="text" id="editName" style="margin-bottom:15px;"><div style="display:flex;gap:15px;margin-bottom:20px;"><input type="number" id="editPrice"><input type="number" id="editQty"></div><div style="display:flex;gap:10px;"><button class="btn" onclick="saveEdit()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button><button class="btn" style="background:var(--input-bg);color:var(--text-main);border:1px solid var(--border-strong);" onclick="document.getElementById('editModal').style.display='none'">–û—Ç–º–µ–Ω–∞</button></div></div></div>
    <div id="deleteModal" class="modal-overlay"><div class="modal-box"><h3 style="margin-bottom:15px;">–£–¥–∞–ª–µ–Ω–∏–µ</h3><p style="color:var(--text-sub);margin-bottom:25px;">–í—ã —É–≤–µ—Ä–µ–Ω—ã?</p><div style="display:flex;gap:10px;"><button class="btn" style="background:var(--danger);color:white;" onclick="confirmDelete()">–£–¥–∞–ª–∏—Ç—å</button><button class="btn" style="background:var(--input-bg);color:var(--text-main);border:1px solid var(--border-strong);" onclick="document.getElementById('deleteModal').style.display='none'">–û—Ç–º–µ–Ω–∞</button></div></div></div>
    <!-- –£–¥–∞–ª–µ–Ω —Å—Ç–∞—Ä—ã–π sheetModal, —Ç–∞–∫ –∫–∞–∫ —Ç–µ–ø–µ—Ä—å –≤–µ–∑–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Picker -->

    <!-- –¶–ï–ù–¢–†–ê–õ–¨–ù–û–ï –û–ö–ù–û –°–ü–ò–°–ö–ê –ë–†–û–ù–ò -->
    <div id="bookingSheet" class="sheet-overlay" onclick="if(event.target.id==='bookingSheet') closeBookingSheet()">
        <div class="sheet-box booking-sheet-box" id="bookingSheetBox">
            <div class="sheet-header booking-sheet-header">
                <div><span class="sheet-title" id="bookingSheetTitle">–î–∞—Ç–∞</span><span style="display:block;font-size:12px;color:var(--text-sub)" id="bookingSheetSubtitle">...</span></div>
                <span class="sheet-close" onclick="closeBookingSheet()">–ó–∞–∫—Ä—ã—Ç—å</span>
            </div>
            <div style="padding-bottom:15px;"><button class="btn" style="padding:10px;margin:0;" onclick="openAddBookingForm(activeBookingDate)">Ôºã –î–æ–±–∞–≤–∏—Ç—å –±—Ä–æ–Ω—å</button></div>
            <div id="bookingSheetContent" class="booking-sheet-content"><div class="booking-empty">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div></div>
        </div>
    </div>

    <!-- –§–û–†–ú–ê –î–û–ë–ê–í–õ–ï–ù–ò–Ø –ë–†–û–ù–ò -->
    <div id="addBookingSheet" class="sheet-overlay" onclick="if(event.target.id==='addBookingSheet') closeAddBookingForm()">
        <div class="sheet-box" style="max-height:85vh; border-radius:24px 24px 0 0;" id="addBookingSheetBox">
            <div class="sheet-header"><span class="sheet-title" id="bookingFormTitle">–ù–æ–≤–∞—è –±—Ä–æ–Ω—å</span><span class="sheet-close" onclick="closeAddBookingForm()">–û—Ç–º–µ–Ω–∞</span></div>
            <div class="booking-form-grid">
                <div><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input id="bookingTitle" type="text" oninput="updateBookingFormField('name', this.value)"><div class="field-error" id="bookingErrorName"></div></div>
                <div class="booking-form-row">
                    <div>
                        <label>–î–∞—Ç–∞</label>
                        <input id="bookingDate" type="text" readonly placeholder="–í—ã–±–µ—Ä–∏—Ç–µ" onclick="openIOSPicker('date', this.value, (v)=>updateBookingFormField('date',v))" style="cursor:pointer;caret-color:transparent;">
                        <div class="field-error" id="bookingErrorDate"></div>
                    </div>
                    <div>
                        <label>–ù–∞—á–∞–ª–æ</label>
                        <input id="bookingStart" type="text" readonly placeholder="00:00" onclick="openIOSPicker('time', this.value, (v)=>updateBookingFormField('startTime',v))" style="cursor:pointer;caret-color:transparent;">
                        <div class="field-error" id="bookingErrorStartTime"></div>
                    </div>
                </div>
                <div class="booking-form-row">
                    <div><label>–û–∫–æ–Ω—á–∞–Ω–∏–µ</label><input id="bookingEnd" type="text" readonly placeholder="00:00" onclick="openIOSPicker('time', this.value, (v)=>updateBookingFormField('endTime',v))" style="cursor:pointer;caret-color:transparent;"><div class="field-error" id="bookingErrorEndTime"></div></div>
                    <div><label>–¶–µ–Ω–∞</label><input id="bookingPrice" type="number" oninput="updateBookingFormField('price', this.value)"><div class="field-error" id="bookingErrorPrice"></div></div>
                </div>
                <div class="booking-form-row">
                    <div><label>–ö–æ–ª-–≤–æ</label><input id="bookingQty" type="number" oninput="updateBookingFormField('qty', this.value)"><div class="field-error" id="bookingErrorQty"></div></div>
                    <div><label>–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞</label><input id="bookingPrepayment" type="number" oninput="updateBookingFormField('prepayment', this.value)"></div>
                </div>
                <div class="booking-total"><span>–°—É–º–º–∞</span><span id="bookingTotalText">0 ‚ÇΩ</span></div>
                <button id="bookingFormSubmit" class="btn" onclick="submitBookingForm()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- iOS PICKER MODAL (–£–ù–ò–í–ï–†–°–ê–õ–¨–ù–´–ô) -->
    <div id="iosPickerModal" class="ios-picker-overlay" onclick="closeIOSPicker(event)">
        <div class="ios-picker-container" onclick="event.stopPropagation()">
            <div class="ios-tabs">
                <button class="ios-tab-btn" onclick="closeIOSPicker(null)" style="color:#8e8e93">–û—Ç–º–µ–Ω–∞</button>
                <span class="ios-tab-title" id="iosPickerTitle">–í—ã–±–æ—Ä</span>
                <button class="ios-tab-btn" onclick="confirmIOSPicker()">–ì–æ—Ç–æ–≤–æ</button>
            </div>
            
            <!-- –í—Ä–µ–º—è (–ß–∞—Å—ã : –ú–∏–Ω—É—Ç—ã) -->
            <div id="iosPickerTime" class="picker-area layout-time" style="display:none;">
                <div class="picker-highlight"></div>
                <div class="picker-col" id="col-hours"><div class="padder"></div><div class="padder"></div></div>
                <div class="picker-col"><div style="display:flex;align-items:center;justify-content:center;height:100%;color:white;font-weight:700">:</div></div>
                <div class="picker-col" id="col-minutes"><div class="padder"></div><div class="padder"></div></div>
            </div>
            
            <!-- –î–∞—Ç–∞ (–î–µ–Ω—å –ú–µ—Å—è—Ü –ì–æ–¥) -->
            <div id="iosPickerDate" class="picker-area layout-date" style="display:none;">
                <div class="picker-highlight"></div>
                <div class="picker-col" id="col-day"><div class="padder"></div><div class="padder"></div></div>
                <div class="picker-col" id="col-month"><div class="padder"></div><div class="padder"></div></div>
                <div class="picker-col" id="col-year"><div class="padder"></div><div class="padder"></div></div>
            </div>

            <!-- Generic Single Column (–¥–ª—è –ì–æ–¥–∞ –∏–ª–∏ –ú–µ—Å—è—Ü–∞ –≤ —Ñ–∏–ª—å—Ç—Ä–∞—Ö) -->
            <div id="iosPickerGeneric" class="picker-area layout-single" style="display:none;">
                <div class="picker-highlight"></div>
                <div class="picker-col" id="col-generic" style="flex:1"><div class="padder"></div><div class="padder"></div></div>
            </div>
        </div>
    </div>

    <script>
        // üëá –í–°–¢–ê–í–¨ –°–Æ–î–ê –°–°–´–õ–ö–£ –ò–ó GOOGLE APPS SCRIPT
        const GAS_URL = 'https://script.google.com/macros/s/AKfycby_caHu1HxgSvMq0Qksti7FDUc55NTzLUOJxmCPcJHt8cZeUIkCJmDVeeGo7I2r-k1s/exec'; 

        const IS_GOOGLE = typeof google !== 'undefined' && google.script && google.script.run;
        let currTab = 'income', dataCache = { income: null, expense: null }, config = { incomeItems:[], expenseItems:[] }, charts={};
        let activeBookingDate = null, calendarYear = new Date().getFullYear(), calendarMonth = new Date().getMonth();
        let selYear = new Date().getFullYear(), selMonth = 'all', availableYears = [];
        const monthNames = ["–Ø–Ω–≤–∞—Ä—å","–§–µ–≤—Ä–∞–ª—å","–ú–∞—Ä—Ç","–ê–ø—Ä–µ–ª—å","–ú–∞–π","–ò—é–Ω—å","–ò—é–ª—å","–ê–≤–≥—É—Å—Ç","–°–µ–Ω—Ç—è–±—Ä—å","–û–∫—Ç—è–±—Ä—å","–ù–æ—è–±—Ä—å","–î–µ–∫–∞–±—Ä—å"];
        const weekDays = ["–ü–Ω", "–í—Ç", "–°—Ä", "–ß—Ç", "–ü—Ç", "–°–±", "–í—Å"];

        // --- iOS PICKER LOGIC (–£–ù–ò–í–ï–†–°–ê–õ–¨–ù–ê–Ø) ---
        const iosPickerState = { activeType: null, callback: null, itemHeight: 44, genericMap: [] };
        
        function createPickerItem(text, value) { 
            const d=document.createElement('div'); d.className='picker-item'; d.innerText=text; d.dataset.value=value; 
            return d; 
        }

        function fillPickerColumn(colId, start, end, format='num', selectedVal=null, customList=null) {
            const col = document.getElementById(colId);
            col.innerHTML = '<div class="padder"></div>';
            let targetScroll = 0;
            
            // –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω –∫–∞—Å—Ç–æ–º–Ω—ã–π —Å–ø–∏—Å–æ–∫ [{text, value}]
            if (customList) {
                iosPickerState.genericMap = customList; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏—è
                customList.forEach((item, index) => {
                     const div = createPickerItem(item.text, item.value);
                     div.onclick = () => col.scrollTo({ top: div.offsetTop - iosPickerState.itemHeight, behavior: 'smooth' });
                     col.appendChild(div);
                     // –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π
                     if (String(item.value) === String(selectedVal)) targetScroll = index * iosPickerState.itemHeight;
                });
            } else {
                // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —á–∏—Å–µ–ª
                for(let i=start; i<=end; i++){
                    let text = i, val = i;
                    if(format==='num') text=i.toString().padStart(2,'0');
                    if(format==='months') { text=monthNames[i-1]; val=i; } // 1-12
                    const item = createPickerItem(text, val);
                    item.onclick = () => col.scrollTo({ top: item.offsetTop - iosPickerState.itemHeight, behavior: 'smooth' });
                    col.appendChild(item);
                    if(selectedVal!==null && parseInt(val)==parseInt(selectedVal)) targetScroll = (i - start) * iosPickerState.itemHeight;
                }
            }
            
            col.innerHTML += '<div class="padder"></div>';
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–∫—Ä–æ–ª–ª–∞ –∏ –≤–∏–±—Ä–∞—Ü–∏—è
            col.onscroll = () => {
                const idx = Math.round(col.scrollTop / iosPickerState.itemHeight);
                col.querySelectorAll('.picker-item').forEach(el=>el.classList.remove('active'));
                const items = col.querySelectorAll('.picker-item');
                if(items[idx]) { 
                    items[idx].classList.add('active'); 
                    if(navigator.vibrate && col.dataset.last!=idx){ navigator.vibrate(5); col.dataset.last=idx; }
                }
            };
            
            // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞—á–∞–ª—å–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏
            setTimeout(() => { col.scrollTop=targetScroll; col.dispatchEvent(new Event('scroll')); }, 10);
        }

        function openIOSPicker(type, curVal, onConfirm) {
            iosPickerState.activeType=type; iosPickerState.callback=onConfirm;
            const modal = document.getElementById('iosPickerModal');
            const title = document.getElementById('iosPickerTitle');
            const tArea=document.getElementById('iosPickerTime');
            const dArea=document.getElementById('iosPickerDate');
            const gArea=document.getElementById('iosPickerGeneric');
            
            // –°–±—Ä–æ—Å –≤–∏–¥–∏–º–æ—Å—Ç–∏
            tArea.style.display='none'; dArea.style.display='none'; gArea.style.display='none';
            modal.style.display='flex';

            if(type==='time') {
                title.innerText = '–í—Ä–µ–º—è';
                tArea.style.display='flex';
                let h=12, m=0;
                if(curVal && curVal.includes(':')) [h,m]=curVal.split(':').map(Number);
                fillPickerColumn('col-hours',0,23,'num',h); fillPickerColumn('col-minutes',0,59,'num',m);
            } 
            else if (type==='date') {
                title.innerText = '–î–∞—Ç–∞';
                dArea.style.display='flex';
                let d=new Date().getDate(), m=new Date().getMonth()+1, y=new Date().getFullYear();
                if(curVal) { const p=curVal.split('-'); if(p.length===3){ y=parseInt(p[0]); m=parseInt(p[1]); d=parseInt(p[2]); } }
                fillPickerColumn('col-day',1,31,'num',d); fillPickerColumn('col-month',1,12,'months',m); fillPickerColumn('col-year',y-5,y+5,'num',y);
            } 
            else if (type==='year_filter') {
                title.innerText = '–í—ã–±–µ—Ä–∏—Ç–µ –ì–æ–¥';
                gArea.style.display='flex';
                // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –ª–µ—Ç
                const yearsList = availableYears.map(y => ({text: String(y), value: y}));
                fillPickerColumn('col-generic', 0, 0, null, curVal, yearsList);
            }
            else if (type==='month_filter') {
                title.innerText = '–í—ã–±–µ—Ä–∏—Ç–µ –ú–µ—Å—è—Ü';
                gArea.style.display='flex';
                // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫: –í–µ—Å—å –≥–æ–¥ + 12 –º–µ—Å—è—Ü–µ–≤
                const monthsList = [{text: '–í–µ—Å—å –≥–æ–¥', value: 'all'}];
                monthNames.forEach((m, i) => monthsList.push({text: m, value: i}));
                fillPickerColumn('col-generic', 0, 0, null, curVal, monthsList);
            }
        }

        function closeIOSPicker(e) { if(e && e.target.id!=='iosPickerModal') return; document.getElementById('iosPickerModal').style.display='none'; }

        function confirmIOSPicker() {
            const getVal = (id) => { 
                const c=document.getElementById(id); 
                const idx=Math.round(c.scrollTop/iosPickerState.itemHeight); 
                const item = c.querySelectorAll('.picker-item')[idx];
                return item ? item.dataset.value : null; 
            };
            
            let res = "";
            const type = iosPickerState.activeType;
            
            if(type==='time') res = `${String(getVal('col-hours')).padStart(2,'0')}:${String(getVal('col-minutes')).padStart(2,'0')}`;
            else if (type==='date') res = `${getVal('col-year')}-${String(getVal('col-month')).padStart(2,'0')}-${String(getVal('col-day')).padStart(2,'0')}`;
            else if (type==='year_filter' || type==='month_filter') res = getVal('col-generic');
            
            if(iosPickerState.callback) iosPickerState.callback(res);
            closeIOSPicker({target:{id:'iosPickerModal'}});
        }

        // --- FORM LOGIC ---
        let bookingFormState = { fields: {name:'',date:'',startTime:'',endTime:'',price:'',qty:'1',prepayment:''}, errors: {} };
        function updateBookingFormField(f, v) {
            bookingFormState.fields[f]=v;
            document.getElementById(f==='name'?'bookingTitle':(f==='date'?'bookingDate':(f==='startTime'?'bookingStart':(f==='endTime'?'bookingEnd':(f==='price'?'bookingPrice':(f==='qty'?'bookingQty':'bookingPrepayment')))))).value = v;
            const p=Number(bookingFormState.fields.price)||0, q=Number(bookingFormState.fields.qty)||0;
            document.getElementById('bookingTotalText').innerText = (p*q).toLocaleString() + ' ‚ÇΩ';
        }
        function openAddBookingForm(date) {
            bookingFormState.fields = {name:'',date:date||'',startTime:'',endTime:'',price:'',qty:'1',prepayment:''};
            updateBookingFormField('name',''); updateBookingFormField('date',date||'');
            document.getElementById('addBookingSheet').style.display='flex';
        }
        function closeAddBookingForm() { document.getElementById('addBookingSheet').style.display='none'; }
        function submitBookingForm() {
            const f = bookingFormState.fields;
            if(!f.date) { alert('–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É'); return; }
            const payload = { ...f, participants: f.qty, total: f.price*f.qty };
            setLoading(true);
            safeBackendCall('addBooking', payload).then(()=>{ setLoading(false); closeAddBookingForm(); refreshCalendarPeriod(); showToast('–ë—Ä–æ–Ω—å –¥–æ–±–∞–≤–ª–µ–Ω–∞'); }).catch(()=>{setLoading(false);});
        }

        // --- CALENDAR LOGIC ---
        function renderCalendar(days=[]) {
            const grid=document.getElementById('calendarGrid'); grid.innerHTML='';
            document.getElementById('calendarWeekdays').innerHTML = weekDays.map(d=>`<div>${d}</div>`).join('');
            document.getElementById('calendarTitle').innerText = `${monthNames[calendarMonth]} ${calendarYear}`;
            document.getElementById('calendarYearLabel').innerText = calendarYear;
            const firstDay = new Date(calendarYear, calendarMonth, 1).getDay(); // 0=Sun
            const offset = (firstDay===0 ? 6 : firstDay-1);
            const daysInMonth = new Date(calendarYear, calendarMonth+1, 0).getDate();
            const map = {}; days.forEach(d=>map[d.date]=d);
            for(let i=0; i<offset; i++) grid.innerHTML+=`<div class="calendar-cell outside"></div>`;
            for(let i=1; i<=daysInMonth; i++) {
                const iso = `${calendarYear}-${String(calendarMonth+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                const dData = map[iso];
                const level = dData ? (dData.totalBookings>3?3:(dData.totalBookings>0?2:0)) : 0;
                grid.innerHTML+=`<div class="calendar-cell clickable" ${level?`data-level="${level}"`:''} onclick="openBookingSheet('${iso}')"><span class="date-num">${i}</span></div>`;
            }
        }
        function loadCalendarData() {
            safeBackendCall('getCalendarData', {year:calendarYear, month:calendarMonth}).then(res=>{ renderCalendar(res.days); });
        }
        function changeMonth(d) { calendarMonth+=d; if(calendarMonth>11){calendarMonth=0;calendarYear++;} if(calendarMonth<0){calendarMonth=11;calendarYear--;} renderCalendar(); loadCalendarData(); }
        function changeYear(d) { calendarYear+=d; renderCalendar(); loadCalendarData(); }
        function refreshCalendarPeriod() { loadCalendarData(); }
        function openBookingSheet(iso) {
            activeBookingDate=iso;
            document.getElementById('bookingSheetTitle').innerText = iso.split('-').reverse().join('.');
            document.getElementById('bookingSheet').style.display='flex';
            document.getElementById('bookingSheetContent').innerHTML='<div class="booking-empty">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            safeBackendCall('getBookingsByDate', {date:iso}).then(res=>{
                 const c = document.getElementById('bookingSheetContent'); c.innerHTML='';
                 if(!res.bookings.length) { c.innerHTML='<div class="booking-empty">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</div>'; return; }
                 res.bookings.forEach(b=>{
                     c.innerHTML+=`<div class="booking-card"><div style="display:flex;justify-content:space-between"><span style="font-weight:800">${b.name}</span><span class="booking-status status-${b.status}">${b.status}</span></div><div style="font-size:13px;color:var(--text-sub)">${b.startTime}-${b.endTime} ‚Ä¢ ${b.qty} —á–µ–ª ‚Ä¢ ${b.total}‚ÇΩ</div><button class="btn" style="padding:10px;margin:0" onclick="changeStatus('${b.id}','${b.status==='planned'?'done':'planned'}')">–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button></div>`;
                 });
            });
        }
        function changeStatus(id, newStatus) { safeBackendCall('changeBookingStatus',{id,status:newStatus}).then(()=>{ showToast('–û–±–Ω–æ–≤–ª–µ–Ω–æ'); openBookingSheet(activeBookingDate); refreshCalendarPeriod(); }); }
        function closeBookingSheet() { document.getElementById('bookingSheet').style.display='none'; }

        // --- ANALYTICS ---
        function loadAnalytics() {
            setLoading(true);
            safeBackendCall('getAnalyticsData', {year: selYear, monthIdx: selMonth}).then(res => {
                const d = res.data; setLoading(false);
                renderKPI('kpiInc', d.current.income, d.growth.income, '‚ÇΩ', 'trend-up'); renderKPI('kpiExp', d.current.expense, d.growth.expense, '‚ÇΩ', 'trend-down'); renderKPI('kpiProf', d.current.profit, d.growth.profit, '‚ÇΩ', 'trend-up'); renderKPI('kpiVis', d.current.visitors, d.growth.visitors, '—á–µ–ª', 'trend-up');
                renderAreaChart('chartPulse', d.pulse.labels, [{ label:'–î–æ—Ö–æ–¥', data:d.pulse.income, borderColor:'#34C759', bg:'rgba(52, 199, 89, 0.1)' }, { label:'–†–∞—Å—Ö–æ–¥', data:d.pulse.expense, borderColor:'#FF3B30', bg:'rgba(255, 59, 48, 0.1)' }]);
                renderAreaChart('chartAttendance', d.attendance.labels, [{ label:'–ü–æ—Å–µ—Ç–∏—Ç–µ–ª–∏', data:d.attendance.data, borderColor:'#AF52DE', bg:'rgba(175, 82, 222, 0.1)' }]);
                renderProgressList('listInc', d.pieIncome.labels, d.pieIncome.data, '#34C759'); renderProgressList('listExp', d.pieExpense.labels, d.pieExpense.data, '#FF3B30');
            }).catch(() => { setLoading(false); });
        }
        function renderKPI(id, val, growth, suff, colorCls) {
            document.getElementById(id).innerText = val.toLocaleString() + ' ' + suff;
            const el = document.getElementById(id.replace('kpi','trend'));
            if(el) { const arr = growth>=0?'‚Üó':'‚Üò'; let finalCls = (growth>=0 && colorCls==='trend-up') || (growth<0 && colorCls==='trend-down') ? 'trend-up' : 'trend-down'; if(id==='kpiExp') finalCls = (growth > 0) ? 'trend-down' : 'trend-up'; el.className = `kpi-trend ${finalCls}`; el.innerText = `${arr} ${Math.abs(growth)}%`; }
        }
        function renderAreaChart(id, labels, datasets) {
            if(charts[id]) charts[id].destroy();
            const ctx = document.getElementById(id).getContext('2d');
            charts[id] = new Chart(ctx, { type: 'line', data: { labels, datasets: datasets.map(d=>({...d, borderWidth:2, tension:0.4, fill:true})) }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display:false }, y: { display: false } } } });
        }
        function renderProgressList(id, labels, data, color) {
            const el = document.getElementById(id); el.innerHTML = ''; if(!data.length) return;
            const max = Math.max(...data);
            labels.forEach((lbl, i) => { const pct = (data[i] / max) * 100; el.insertAdjacentHTML('beforeend', `<div class="prog-item"><div class="prog-info"><span>${lbl}</span><span>${data[i].toLocaleString()}</span></div><div class="prog-bar-bg"><div class="prog-bar-fill" style="width:${pct}%; background:${color}"></div></div></div>`); });
        }
        function updateFilterUI() { document.getElementById('txtYear').innerText = selYear; document.getElementById('txtMonth').innerText = (selMonth === 'all') ? '–í–µ—Å—å –≥–æ–¥' : monthNames[selMonth]; }
        // openSheet —É–¥–∞–ª–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è openIOSPicker

        // --- CORE ---
        window.onload = function() {
             if(window.Telegram && window.Telegram.WebApp) window.Telegram.WebApp.expand();
             setLoading(true);
             safeBackendCall('getInitialConfig').then(r=>{config=r; availableYears=r.years; setLoading(false); refreshTable(true); loadCalendarData(); loadAnalytics(); }).catch(()=>{setLoading(false);});
             document.getElementById('venus').addEventListener('animationiteration', ()=>{ if(stopAnim) { document.getElementById('venus').classList.remove('spinning'); stopAnim=false; } });
             
             // SWIPES
             let ts=0; document.addEventListener('touchstart',e=>ts=e.touches[0].clientX);
             document.addEventListener('touchend',e=>{
                 const te=e.changedTouches[0].clientX; if(Math.abs(te-ts)<100) return;
                 const idx=['income','expense','calendar','analytics'].indexOf(currTab);
                 if(te<ts && idx<3) switchTab(['income','expense','calendar','analytics'][idx+1], idx+1);
                 if(te>ts && idx>0) switchTab(['income','expense','calendar','analytics'][idx-1], idx-1);
             });
        };
        let activeReq=0, stopAnim=false;
        function setLoading(a) { const v=document.getElementById('venus'); if(a){activeReq++;stopAnim=false;v.classList.add('spinning');} else{activeReq--;if(activeReq<=0){activeReq=0;stopAnim=true;}} }
        function switchTab(t,i) { 
            document.querySelectorAll('.tab-page').forEach(p=>p.classList.remove('active', 'anim-next', 'anim-prev', 'anim-fade'));
            document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
            document.querySelectorAll('.nav-btn')[i].classList.add('active');
            const p = document.getElementById(t==='calendar'?'calendarTab':(t==='analytics'?'analyticsTab':'splitTab'));
            p.classList.add('active','anim-fade');
            if(t==='calendar') { renderCalendar(); loadCalendarData(); }
            else if(t==='analytics') loadAnalytics();
            else { currTab=t; updateUIForTab(t); refreshTable(); }
            document.getElementById('navInd').style.transform=`translateX(${i*100}%)`;
        }
        function updateUIForTab(t) {
            const isInc = t === 'income';
            document.getElementById('formTitle').innerText = isInc ? '–î–æ–±–∞–≤–∏—Ç—å –ú–ö' : '–î–æ–±–∞–≤–∏—Ç—å –†–∞—Å—Ö–æ–¥';
            document.getElementById('lblSearch').innerText = isInc ? '–ù–∞–∑–≤–∞–Ω–∏–µ' : '–û–ø–∏—Å–∞–Ω–∏–µ';
            document.getElementById('tableTitle').innerText = isInc ? '–î–æ—Ö–æ–¥—ã' : '–†–∞—Å—Ö–æ–¥—ã';
        }
        async function safeBackendCall(act, py={}) {
            if(IS_GOOGLE) return new Promise((res,rej)=>google.script.run.withSuccessHandler(res).withFailureHandler(rej)[act](py.id||py.date||py.year||py));
            else { 
                if(GAS_URL.includes("–í–ê–®_")) { alert("–í—Å—Ç–∞–≤—å —Å—Å—ã–ª–∫—É!"); throw "No URL"; }
                py.action=act; const r=await fetch(GAS_URL,{method:"POST",body:JSON.stringify(py)}); return await r.json(); 
            }
        }
        function refreshTable(f) {
            const t=document.getElementById('tableBody'); if(f) t.innerHTML='';
            safeBackendCall('getTableData',{type:currTab}).then(d=>{
                t.innerHTML = d.rows.map(r=>{
                     const json = JSON.stringify(r).replace(/"/g, '&quot;');
                     return `<tr><td>${r.dateStr.slice(0,5)}</td><td>${r.name}</td><td>${r.total}</td><td><button class="btn-table" onclick="openDelete(${json})"><svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></button></td></tr>`;
                }).join('');
                document.getElementById('emptyMsg').style.display=d.rows.length?'none':'block';
            });
        }
        function submitEntry() { 
            const n=document.getElementById('inpName').value, p=document.getElementById('inpPrice').value, q=document.getElementById('inpQty').value;
            if(!n||!p) return; 
            const isInc=currTab==='income'; const list=isInc?config.incomeItems:config.expenseItems; if(!list.includes(n)) list.push(n);
            safeBackendCall('saveTransaction',{type:currTab, name:n, price:p, qty:q, total:p*q, isNew:true}).then(()=>{ showToast('–î–æ–±–∞–≤–ª–µ–Ω–æ'); refreshTable(true); });
        }
        function openDelete(r) { document.getElementById('deleteModal').style.display='flex'; window.delId=r.rowId; }
        function confirmDelete() { safeBackendCall('deleteTransaction',{rowId:window.delId, type:currTab}).then(()=>{showToast('–£–¥–∞–ª–µ–Ω–æ'); refreshTable(true); document.getElementById('deleteModal').style.display='none'}); }
        function modVal(id,d) { const e=document.getElementById(id); e.value=Math.max((id==='inpQty'?1:0), (Number(e.value)||0)+d); calcTotal(); }
        function calcTotal() { document.getElementById('txtTotal').innerText = ((Number(document.getElementById('inpPrice').value)||0)*(Number(document.getElementById('inpQty').value)||0)).toLocaleString()+' ‚ÇΩ'; }
        function showSearch(e) { 
            const v=e.target.value.toLowerCase(), b=document.getElementById('searchRes'), list=currTab==='income'?config.incomeItems:config.expenseItems;
            b.innerHTML=''; if(!v){b.style.display='none';return;}
            const f=list.filter(i=>i.toLowerCase().includes(v));
            if(f.length){b.style.display='block'; f.forEach(r=>{b.innerHTML+=`<div class="res-item" onclick="document.getElementById('inpName').value='${r}';this.parentElement.style.display='none'">${r}</div>`});}
            else b.style.display='none';
        }
        function showToast(m) { const t=document.getElementById('toast'); t.innerText=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3000); }
        function toggleTheme() { const b=document.body; b.dataset.theme=b.dataset.theme==='dark'?'light':'dark'; }
    </script>
</body>
</html>
